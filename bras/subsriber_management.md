# Subscriber management. Управление подписчиками.

### TheRouter поддерживает следующие функции и технологии, необходимые для управления подпичиками и создания BRAS сервера.
 * L2/L3 connected subscribers
 * vlan per subsriber with ip unnumbered adresses
 * proxy arp
 * traffic shaping (Token bucket filter with extended burst value)
 * DHCP relay
 * redirect subsriber traffic based on multiple routing tables and PBR
 * radius/coa

## Варианты подключений подписчиков

### L2 connected subscribers

<img src="http://therouter.net/images/bras/l2_connected_subsc_overview.png">

Подписчики и раутер подключаются друг к другу через общий L2 широковещательный домен.
На раутере настраивается интерфейс, используемый для создания сессий подписчиков.
Этот интерфейс может использовать любой вариант инкапсуляции: untagged, dot1q, qinq.
В настройках интерфейса должен быть указан флаг l2_subs, разрешающий раутеру создание 
сессий подписчиков на этом интерфейсе. 

	vif add name v_subsc port 0 type qinq svid 2 cvid 121 flags l2_subs

Создание сессии подписчика инициируется входящим или исходящим 
неклассифицированным ip пакетом. Неклассифицированным пакетом считается пакет, ip адрес которого
(ip адрес назначения в случае исходящих пакетов или ip адрес источника для входящих пакетов)
не принадлежит ни одной из авторизованных сессий.

Для авторизации сессии используется radius протокол.
Запрос на авторизацию L2 subsriber ceccии включает следующие атрибуты:

todo

### L3 connected subscribers

<img src="http://therouter.net/images/bras/l3_connected_subsc_overview.png">

L2 трафик подписчиков терминируется на отдельном маршрутизаторе, который в свою очередь, 
подключается к the_router через любой доступный на нем интерфейс.
Этот интерфейс может использовать любой вариант инкапсуляции: untagged, dot1q, qinq.
В настройках интерфейса должен быть указан флаг l3_subs, разрешающий раутеру создание 
сессий подписчиков на этом интерфейсе.

	vif add name v21 port 0 type dot1q cvid 21 flags l3_subs

Создание сессии подписчика инициируется входящим или исходящим 
неклассифицированным ip пакетом. Неклассифицированным пакетом считается пакет, ip адрес которого
(ip адрес назначения в случае исходящих пакетов или ip адрес источника для входящих пакетов)
не принадлежит ни одной из авторизованных сессий.

Для авторизации сессии используется radius протокол.
Запрос на авторизацию L3 subsriber ceccии включает следующие атрибуты:

todo

### Vlan per subscriber

<img src="http://therouter.net/images/bras/vlan_per_subsc_overview.png">

Каждый подписчик подключается к сети через отдельный vlan (dot1q или qinq).
The_router подключается к сети через trunk порт, через который ему доступен
трафик всех вланов подписчиков. На этом порту the_router'а динамически создаются
интерфейсы (vif) для каждого подписчика. Создание динамического интерфейса (vif)
подписчика происходит только по входящему неклассифицированному пакету. Неклассифицированным
считается пакет, vlan информация из заголовков которого, не соответсвует ни одному авторизованному
динамическому интерфейсу подписчика. Вастройки порта the_router, к которому подключеные подписчики, 
должны включать флаг dynamic_vif, разрещающий создание динамических интерфейсов подписчиков.

	port 0 mtu 1500 tpid 0x8100 state enabled flags dynamic_vif

Авторизация создания динамических интерфейсов подписчиков выполняется с помощью radius протокола.
Запрос на авторизацию интерфейса подписчика включает следующие атрибуты:

 * THE_ROUTER_VSA_OUTER_VID - Внешняя влан метка или service vlan id (svid). Задается всегда. Для dot1q интерфейса используется значение 0.
	
 * THE_ROUTER_VSA_INNER_VID - Внутренняя влан метка или customer vlan id (cvid).

 * THE_ROUTER_VSA_PORT_ID - Номер порта TheRouter.

 * Username - для динамических интерфейсов формируется на основе полей portid, svid и сvid
путем их объединения в одну строку с исользованием точки в качестве разделителя.
	
#### Ответ на запрос авторизации
Ответ может включать перечисленные ниже атрибуты. В зависимости от наличия того или иного атрибута
после создания интерфейса к нему будут применены соответствующие политики и сервисы.

 * THE_ROUTER_VSA_IP_UNNUMBERED_VIF - наличие этого атрибута в ответе указывает на необходиость
настройки ip адресации созданного интфейса по принципу ip unnumbered. Т.е. TheRouter добавляет
IPv4 адрес в список адресов интерфейса и создает маршрут к адресу пользователя через этот интерфейс.
Т.е. TheRouter выполняет следующие команды:

	ip addr add <GW_IP>/32 dev <dynamic_vif>
	ip route add <SUB_IP>/32 dev <dynamic_vif> src <GW_IP>
	
Где:
 * GW_IP - адрес TheRouter, одинаковый для всех динамических интерфейсов, использующих общую подсеть IPv4.
 * SUB_IP - адрес пользователя.
	
Адреса GW_IP,SUB_IP определяются атрибутами:
 * THE_ROUTER_VSA_IPV4 задает адрес SUB_IP. В качестве значения принимается целое положительное число.
 * THE_ROUTER_VSA_IPV4_MASK задает маску для SUB_IP. В качестве значения принимается целое положительное число. Например 24.
 * THE_ROUTER_VSA_IPV4_GW задает адрес GW_IP В качестве значения принимается целое положительное число.
	
арибут THE_ROUTER_VSA_IPV4_GW необязателен и может быть рассчитан как первый адрес в сети.
	
 * THE_ROUTER_VSA_INGRESS_CIR
 * THE_ROUTER_VSA_EGRESS_CIR
		задают ограничение входящей и исходящей скорости для интерфейса.
		В качестве значения ипользуется челое положительное число, задающее скрость в Мбит/c.

 * THE_ROUTER_VSA_PBR - атрибут, контролирующий настройку PBR маршрутизации для входящих пакетов динамического интерфейса.
В зависимости от значения атрибута в таблицу поиска, исользуемую PBR правилами,
добавляется или удаляется идентификатор динамического интерфейса.

	1 - добавить id интерфейса в таблицу
	2 - удалить id интерфейса из таблицы
			 
Имя таблицы, используемой этим механизмом, задается в конфигурационном файле директивой:

	subsc u32set init <IP_TABLE_NAME> <L2_TABLE_NAME>

Где:

IP_TABLE_NAME - имя таблицы с IP адресами. Она используется для L2/L3 сессий, 
т.к. идентификатор таких сессий - IP адрес пользователя.
	
L2_TABLE_NAME - имя таблицы c L2 идентификаторами динамических интерфейсов.

Сами таблицы, правила PBR, использующие их, дополнтельные таблицы маршрутизации 
должны также быть заданы в конфигурационном файле до директивы subsc u32set init.
